<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Story</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            /* Fallback/Dynamic CSS Variables (Set in JS) */
            --site-nuance-light: #2563eb; 
            --site-nuance-dark: #60a5fa; 
            --tile-nuance-light: #ff6600; /* Content Nuance */
            --tile-nuance-dark: #ff8833;
            --footer-bg-light: #f3f4f6;
            --footer-bg-dark: #1f2937;
        }
        
        /* PayPal Button Styling */
        .paypal-btn {
            background-color: #FFC439;
            color: #000;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: filter 0.2s;
        }
        .paypal-btn:hover { filter: brightness(0.95); }

        /* Media Handling: FIX for use_soft_bg: true (transparent PNG fix) */
        .soft-bg { background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(200,200,200,0.2) 100%) !important; }
        .dark .soft-bg { background: radial-gradient(circle, rgba(50,50,50,0.5) 0%, rgba(0,0,0,0.2) 100%) !important; }
        
        /* FIX: Enhanced HTML/MD Formatting (Nuance for embedded headings) */
        .formatted-text strong { font-weight: 700; color: inherit; }
        .formatted-text p { margin-bottom: 1rem; }
        .formatted-text h1, .formatted-text h2, .formatted-text h3 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            line-height: 1.25;
            /* Subtitle headers use the CONTENT (Tile) Nuance */
            color: var(--tile-nuance-light); 
        }
        .dark .formatted-text h1, .dark .formatted-text h2, .dark .formatted-text h3 {
             color: var(--tile-nuance-dark);
        }

        /* Dynamic Nuance Color Styles */
        /* Site Nuance (Frame) - for Nav, Header Title Gradient End, etc. */
        .site-nuance-text { color: var(--site-nuance-light) !important; }
        .dark .site-nuance-text { color: var(--site-nuance-dark) !important; }
        /* Tile Nuance (Content) - for Subtitle border, Main title icon, buttons */
        .tile-nuance-text { color: var(--tile-nuance-light) !important; }
        .dark .tile-nuance-text { color: var(--tile-nuance-dark) !important; }
        .tile-nuance-border-l { border-color: var(--tile-nuance-light) !important; }
        .dark .tile-nuance-border-l { border-color: var(--tile-nuance-dark) !important; }
        
        /* Language Switcher Styling */
        .lang-switch span { cursor: pointer; transition: color 0.2s; }
        .lang-switch span.active { font-weight: bold; border-bottom: 2px solid currentColor; }
    </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 flex flex-col">

    <header class="w-full p-4 border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            
            <a href="index.html" class="flex items-center gap-2 text-xl font-bold transition">
                <span class="h-6 w-6 flex items-center justify-center text-xl site-nuance-text"><i data-lucide="" id="site-symbol-icon" class="w-6 h-6"></i></span> 
                <div class="flex flex-col">
                    <span id="site-name-nav" class="hidden sm:inline text-xl md:text-2xl font-bold tracking-tight leading-none"></span>
                    <p id="site-subtitle-nav" class="text-xs text-gray-500 dark:text-gray-400 font-medium"></p>
                </div>
            </a>
            
            <div class="flex items-center gap-6">
                
                <div class="flex items-center gap-4 text-lg site-nuance-text">
                    <a id="nav-prev" href="#" class="opacity-50 pointer-events-none transition hover:opacity-100"></a> 
                    <span id="nav-sep" class="text-gray-400"></span>
                    <a id="nav-next" href="#" class="opacity-50 pointer-events-none transition hover:opacity-100"></a>
                </div>

                <div class="lang-switch text-sm font-medium text-gray-500 dark:text-gray-400 flex gap-2 border-l border-gray-300 dark:border-gray-700 pl-4">
                    <span class="active text-gray-900 dark:text-gray-100">EN</span>
                    <span class="hover:text-gray-900 dark:hover:text-gray-100">DE</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow px-6 py-10">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-10">
            
            <div class="md:col-span-5 flex flex-col gap-4 md:sticky md:top-24 h-fit">
                
                <div id="media-container" class="rounded-2xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
                    </div>

                <p id="media-caption" class="text-sm text-gray-500 dark:text-gray-400 text-center"></p>

                <h1 id="content-title" class="text-3xl md:text-5xl font-extrabold bg-clip-text text-transparent inline-flex items-center gap-4" style="background-image: linear-gradient(to right, var(--tile-nuance-light), var(--site-nuance-light));">
                     <i data-lucide="" id="story-symbol-icon" class="tile-nuance-text w-10 h-10"></i>
                </h1>

                <div id="content-intro" class="text-lg md:text-xl text-gray-700 dark:text-gray-300 leading-relaxed formatted-text"></div>

            </div>

            <div class="md:col-span-7 flex flex-col gap-8 md:pt-4">
                <div id="dynamic-content" class="flex flex-col gap-6">
                    </div>
            </div>

        </div>
    </main>

    <footer id="main-footer" class="w-full py-6 text-center text-gray-900 text-sm border-t border-gray-200 dark:text-gray-100 mt-12" style="background-color: var(--footer-bg-light);">
        <div class="max-w-6xl mx-auto flex items-center justify-center gap-2">
            <span id="footer-part1"></span>
            <img id="footer-logo" src="" alt="Logo" class="object-contain opacity-70" style="width: 100%; height: auto;">
            <span id="footer-part2"></span>
        </div>
    </footer>

    <script>
        // --- COLOR HELPER FUNCTIONS ---
        function isValidHex(color) {
            return /^#([0-9A-F]{3}){1,2}$/i.test(color);
        }
        function lightenColor(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16),
                g = parseInt(hex.substring(3, 5), 16),
                b = parseInt(hex.substring(5, 7), 16);

            const amount = Math.floor((255 * percent) / 100);

            r = Math.min(255, r + amount);
            g = Math.min(255, g + amount);
            b = Math.min(255, b + amount);

            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        function darkenColor(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16), g = parseInt(hex.substring(3, 5), 16), b = parseInt(hex.substring(5, 7), 16);
            const amount = Math.floor((255 * percent) / 100);
            r = Math.max(0, r - amount);
            g = Math.max(0, g - amount);
            b = Math.max(0, b - amount);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        async function loadPortfolio() {
            const response = await fetch('content.json');
            const data = await response.json();
            const config = data.page_config;

            // 1. Identify current page ID from filename (e.g., 'story1' from 'story1.html')
            const path = window.location.pathname;
            const pageId = path.substring(path.lastIndexOf('/') + 1).replace('.html', '') || 'story1'; 
            const langKey = config.language.language_default;

            // --- 2. Find full story content in index.tiles ---
            const storyTile = data[langKey].index.tiles.find(tile => tile.config.id === pageId);

            if(!storyTile) {
                document.body.innerHTML = "<div class='p-10 text-center'><h1>Story Content Not Found in JSON</h1><p>Please ensure a tile with ID '" + pageId + "' exists in your content.json file.</p></div>";
                return;
            }

            // --- 3. DYNAMIC NUANCE COLOR SETUP (The FRAME Color) ---
            const preferences = config.preferences;
            let siteColor = preferences.site_nuance_color || '#2563eb';
            if (isValidHex(siteColor)) {
                document.documentElement.style.setProperty('--site-nuance-light', siteColor);
                document.documentElement.style.setProperty('--site-nuance-dark', lightenColor(siteColor, 20));
            }

            // --- 4. TILE NUANCE COLOR SETUP (The CONTENT Color) ---
            let tileColor = storyTile.config.color || siteColor;
            if (isValidHex(tileColor)) {
                document.documentElement.style.setProperty('--tile-nuance-light', tileColor);
                document.documentElement.style.setProperty('--tile-nuance-dark', lightenColor(tileColor, 15)); 
            }
            
            // --- 5. HEADER & NAVIGATION SETUP ---
            const navigation = config.navigation;
            const titleElement = document.getElementById('content-title');

            document.getElementById('site-name-nav').innerText = preferences.site_title;
            document.getElementById('site-subtitle-nav').innerText = preferences.site_subtitle;
            document.getElementById('site-symbol-icon').setAttribute('data-lucide', preferences.site_symbol);
            
            // Story Content Symbol
            document.getElementById('story-symbol-icon').setAttribute('data-lucide', storyTile.config.symbol);
            // Append Title Text to the h1 tag (after the icon)
            titleElement.innerHTML += storyTile.content.tile_story_title;

            // Navigation Arrows (Use Site Nuance)
            document.getElementById('nav-sep').innerText = navigation.navigation_separator;

            const prevLink = document.getElementById('nav-prev');
            prevLink.innerText = navigation.navigation_previous;
            if(storyTile.config.prev_story_url) {
                prevLink.href = storyTile.config.prev_story_url;
                prevLink.classList.remove('opacity-50', 'pointer-events-none');
            }

            const nextLink = document.getElementById('nav-next');
            nextLink.innerText = navigation.navigation_next;
            if(storyTile.config.next_story_url) {
                nextLink.href = storyTile.config.next_story_url;
                nextLink.classList.remove('opacity-50', 'pointer-events-none');
            }


            // --- 6. MEDIA RENDER (with Caption) ---
            const mediaBox = document.getElementById('media-container');
            const isMobile = window.innerWidth < 768; 

            if (storyTile.media.media_use_soft_bg) mediaBox.classList.add('soft-bg');
            
            let mediaHTML = '';
            const sizeValue = storyTile.media.media_size ? parseInt(storyTile.media.media_size.replace('%', '')) : 100;
            // Apply media_size
            const sizeStyle = (sizeValue <= 100) ? `style="max-width: ${sizeValue}%;"` : `style="max-width: 100%;"`;
            const mediaClass = "w-full h-auto object-contain p-2 mx-auto";


            // Check if it's a video based on the URL ending
            const isVideo = storyTile.media.media_url.match(/\.(mp4|webm|mov|ogg)$/i); 
            
            // Look for mobile video/webp if it's a video and we are on mobile
            let videoSrc = storyTile.media.media_url; 
            if (isVideo && isMobile && (storyTile.media.media_mobile_url || storyTile.media['media_mobile-url'])) {
                videoSrc = storyTile.media.media_mobile_url || storyTile.media['media_mobile-url'];
            }

            if (isVideo) {
                 // Determine type based on file extension
                const videoType = videoSrc.match(/\.webm$/i) ? 'video/webm' : (videoSrc.match(/\.webp$/i) ? 'image/webp' : 'video/mp4');
                
                // Use a standard video tag if it's a video
                if (videoType.startsWith('video/')) {
                    mediaHTML = `
                        <video autoplay loop muted playsinline class="${mediaClass}" ${sizeStyle}>
                            <source src="${videoSrc}" type="${videoType}">
                        </video>
                    `;
                } else {
                    // Treat as an image if it's a webp fallback
                     mediaHTML = `<img src="${videoSrc}" alt="${storyTile.media.media_caption || storyTile.content.tile_story_title}" class="${mediaClass}" ${sizeStyle}>`;
                }

            } else {
                // Default to image
                mediaHTML = `<img src="${storyTile.media.media_url}" alt="${storyTile.media.media_caption || storyTile.content.tile_story_title}" class="${mediaClass}" ${sizeStyle}>`;
            }
            
            mediaBox.innerHTML = mediaHTML;
            
            // Display Caption
            if (storyTile.media.media_caption) {
                document.getElementById('media-caption').innerText = storyTile.media.media_caption;
            }

            // Display Intro
            document.getElementById('content-intro').innerHTML = storyTile.content.tile_story_description; 

            // --- 7. FOOTER SETUP ---
            const footer = config.footer;
            document.getElementById('footer-part1').innerText = footer.footer_text1;
            document.getElementById('footer-logo').src = footer.footer_logo_url;
            // Apply dynamic logo size
            document.getElementById('footer-logo').style.maxWidth = footer.footer_logo_size;
            document.getElementById('footer-part2').innerText = footer.footer_text2;

            // Footer Background Logic (same as index.html)
            const mainFooter = document.getElementById('main-footer');
            if (footer.display_foorter_bg) {
                let footerBgColor = footer.footer_bg_color || footer.footer_nuance_color; 
                if (isValidHex(footerBgColor)) {
                    document.documentElement.style.setProperty('--footer-bg-light', footerBgColor);
                    document.documentElement.style.setProperty('--footer-bg-dark', darkenColor(footerBgColor, 40)); 
                    
                    const styleSheet = document.createElement("style");
                    styleSheet.type = "text/css";
                    styleSheet.innerText = `
                        #main-footer { border-color: var(--footer-bg-dark) !important; }
                        .dark #main-footer { 
                            background-color: var(--footer-bg-dark) !important;
                            color: white; 
                        }
                        .dark #main-footer img { opacity: 0.9 !important; }
                    `;
                    document.head.appendChild(styleSheet);
                    
                    // Apply light mode footer background inline
                    mainFooter.style.backgroundColor = footerBgColor;
                    mainFooter.classList.remove('dark:text-gray-100'); // Ensure color contrast
                }
            }


            // --- 8. DYNAMIC CONTENT RENDER ---
            const dynamicContainer = document.getElementById('dynamic-content');
            dynamicContainer.innerHTML = ''; 

            // Block 1: Subtitle 1 + Text 1 (Tile Nuance Border)
            if (storyTile.content.story_subtitle1) {
                dynamicContainer.innerHTML += `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 border-l-4 tile-nuance-border-l pl-4">${storyTile.content.story_subtitle1}</h2>`;
            }
            if (storyTile.content.story_text1) {
                dynamicContainer.innerHTML += `<div class="text-gray-600 dark:text-gray-300 leading-relaxed formatted-text">${storyTile.content.story_text1}</div>`;
            }

            // Block 2: Subtitle 2 + Text 2 (Handles both "story_subtitle2" and "story_subtitle2(optional)" fields)
            const subtitle2 = storyTile.content['story_subtitle2'] || storyTile.content['story_subtitle2(optional)'];
            const text2 = storyTile.content['story_text2'] || storyTile.content['story_text2)optional)'];
            
            if (subtitle2) {
                dynamicContainer.innerHTML += `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 border-l-4 tile-nuance-border-l pl-4">${subtitle2}</h2>`;
            }
            if (text2) {
                dynamicContainer.innerHTML += `<div class="text-gray-600 dark:text-gray-300 leading-relaxed formatted-text">${text2}</div>`;
            }

            // Block 3: Attachment (Uses Tile Nuance for link/button)
            const block = storyTile.attachement;
            let blockHTML = '';

            switch(block.type.toLowerCase()) {
                case 'paypal_button':
                    blockHTML = `
                        <div class="py-4">
                            <a href="https://www.paypal.com/donate?hosted_button_id=${block.hosted_id}" target="_blank" class="paypal-btn shadow-lg hover:shadow-xl transform transition hover:-translate-y-1">
                                <i data-lucide="heart" class="w-5 h-5 text-red-600"></i>
                                <span>${block.text || "Support a Way Forward"}</span>
                            </a>
                        </div>`;
                    break;
                case 'link':
                    blockHTML = `
                        <a href="${block.url}" class="inline-flex items-center gap-2 tile-nuance-text font-medium hover:underline mt-2">
                            <i data-lucide="${block.action === 'download' ? 'download' : 'link'}" class="w-4 h-4"></i>
                            ${block.text}
                        </a>`;
                    break;
            }
            dynamicContainer.innerHTML += blockHTML;

            lucide.createIcons();
        }

        // --- DARK MODE SYSTEM PREFERENCE CHECK ---
        const htmlEl = document.documentElement;
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            htmlEl.classList.add('dark');
        } else {
            htmlEl.classList.remove('dark');
        }

        loadPortfolio();
    </script>
</body>
</html>