<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Story</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            /* Fallback/Dynamic CSS Variables (Set in JS) */
            --nuance-color-light: #2563eb; 
            --nuance-color-dark: #60a5fa;  
        }
        
        /* PayPal Button Styling */
        .paypal-btn {
            background-color: #FFC439;
            color: #000;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: filter 0.2s;
        }
        .paypal-btn:hover { filter: brightness(0.95); }

        /* Media Handling: FIX for use_soft_bg: true (transparent PNG fix) */
        .soft-bg { background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(200,200,200,0.2) 100%) !important; }
        .dark .soft-bg { background: radial-gradient(circle, rgba(50,50,50,0.5) 0%, rgba(0,0,0,0.2) 100%) !important; }
        
        /* FIX: Enhanced HTML/MD Formatting (Nuance for embedded headings) */
        .formatted-text strong { font-weight: 700; color: inherit; }
        .formatted-text p { margin-bottom: 1rem; }
        .formatted-text h1, .formatted-text h2, .formatted-text h3 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            line-height: 1.25;
            color: var(--nuance-color-light); 
        }
        .dark .formatted-text h1, .dark .formatted-text h2, .dark .formatted-text h3 {
             color: var(--nuance-color-dark);
        }
        .formatted-text h1 { font-size: 2.25rem; } 
        .formatted-text h2 { font-size: 1.875rem; } 
        .formatted-text h3 { font-size: 1.5rem; }   

        /* Dynamic Nuance Color Styles (Nav, Links) */
        .nuance-text { color: var(--nuance-color-light) !important; }
        .dark .nuance-text { color: var(--nuance-color-dark) !important; }
        .nuance-border-l { border-color: var(--nuance-color-light) !important; }
        .dark .nuance-border-l { border-color: var(--nuance-color-dark) !important; }
        
        /* Language Switcher Styling */
        .lang-switch span { cursor: pointer; transition: color 0.2s; }
        .lang-switch span.active { font-weight: bold; border-bottom: 2px solid currentColor; }
    </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 flex flex-col">

    <header class="w-full p-4 border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            
            <a href="index.html" class="flex items-center gap-2 text-xl font-bold transition">
                <span id="nav-home-icon" class="nuance-text hover:text-opacity-80"></span> 
                <span id="site-name-nav" class="hidden sm:inline"></span>
            </a>
            
            <div class="flex items-center gap-6">
                
                <div class="flex items-center gap-4 text-lg">
                    <a id="nav-prev" href="#" class="nuance-text opacity-50 pointer-events-none transition hover:text-opacity-100"></a> 
                    <span id="nav-sep" class="text-gray-400"></span>
                    <a id="nav-next" href="#" class="nuance-text opacity-50 pointer-events-none transition hover:text-opacity-100"></a>
                </div>

                <div class="lang-switch text-sm font-medium text-gray-500 dark:text-gray-400 flex gap-2 border-l border-gray-300 dark:border-gray-700 pl-4">
                    <span class="active text-gray-900 dark:text-gray-100">EN</span>
                    <span class="hover:text-gray-900 dark:hover:text-gray-100">DE</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow px-6 py-10">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-10">
            
            <div class="md:col-span-5 flex flex-col gap-4 md:sticky md:top-24 h-fit">
                
                <div id="media-container" class="rounded-2xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
                    </div>

                <p id="media-caption" class="text-sm text-gray-500 dark:text-gray-400 text-center"></p>

                <h1 id="content-title" class="text-3xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 dark:from-gray-100 to-[var(--nuance-color-light)] dark:to-[var(--nuance-color-dark)]"></h1>

                <div id="content-intro" class="text-lg md:text-xl text-gray-700 dark:text-gray-300 leading-relaxed formatted-text"></div>

            </div>

            <div class="md:col-span-7 flex flex-col gap-8 md:pt-4">
                <div id="dynamic-content" class="flex flex-col gap-6">
                    </div>
            </div>

        </div>
    </main>

    <footer class="w-full py-6 text-center text-gray-500 text-sm border-t border-gray-200 dark:border-gray-800 mt-12">
        <div class="max-w-6xl mx-auto flex items-center justify-center gap-2">
            <span id="footer-part1"></span>
            <img id="footer-logo" src="" alt="Logo" class="h-8 w-8 object-contain opacity-50">
            <span id="footer-part2"></span>
        </div>
    </footer>

    <script>
        // --- DARK MODE SYSTEM PREFERENCE CHECK ---
        const htmlEl = document.documentElement;
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            htmlEl.classList.add('dark');
        } else {
            htmlEl.classList.remove('dark');
        }
        
        // --- COLOR HELPER FUNCTIONS ---
        function isValidHex(color) {
            return /^#([0-9A-F]{3}){1,2}$/i.test(color);
        }
        function lightenColor(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16),
                g = parseInt(hex.substring(3, 5), 16),
                b = parseInt(hex.substring(5, 7), 16);

            const amount = Math.floor((255 * percent) / 100);

            r = Math.min(255, r + amount);
            g = Math.min(255, g + amount);
            b = Math.min(255, b + amount);

            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        async function loadPortfolio() {
            const response = await fetch('content.json');
            const data = await response.json();
            const config = data.page_config;

            // 1. Identify current page ID from filename (e.g., 'story1' from 'story1.html')
            const path = window.location.pathname;
            const pageId = path.substring(path.lastIndexOf('/') + 1).replace('.html', '') || 'story1'; 

            // --- 2. Map Site Settings from page_config ---
            const site = {
                name: config.preferences.site_title,
                navigation_home: config.navigation.navigation_home,
                navigation_separator: config.navigation.navigation_separator,
                navigation_next: config.navigation.navigation_next,
                navigation_previous: config.navigation.navigation_previous,
                footer1: config.footer.footer_text1,
                footer2: config.footer.footer_text2,
                logo_url: config.footer.footer_logo_url
            };
            const nuanceColorFallback = config.preferences.site_nuance_color;

            // --- 3. Find full story content in index.tiles (New JSON structure) ---
            const storyTile = data.en.index.tiles.find(tile => tile.config.id === pageId);

            if(!storyTile) {
                document.body.innerHTML = "<div class='p-10 text-center'><h1>Story Content Not Found in JSON</h1></div>";
                return;
            }

            // --- 4. DYNAMIC NUANCE COLOR SETUP ---
            let nuanceColor = '#2563eb'; // Default Blue

            // 1. Get color from the found tile
            if (isValidHex(storyTile.config.color)) {
                nuanceColor = storyTile.config.color;
            } 
            // 2. Fallback to site nuance color
            else if (nuanceColorFallback && isValidHex(nuanceColorFallback)) {
                nuanceColor = nuanceColorFallback; 
            }

            // Set the CSS variables for use in <style>
            document.documentElement.style.setProperty('--nuance-color-light', nuanceColor);
            // Lighten for dark mode accent for better contrast
            const darkNuance = lightenColor(nuanceColor, 15); 
            document.documentElement.style.setProperty('--nuance-color-dark', darkNuance);
            
            // --- 5. SITE DATA & FOOTER ---
            document.getElementById('site-name-nav').innerText = site.name;
            document.getElementById('nav-home-icon').innerText = site.navigation_home;
            
            document.getElementById('footer-part1').innerText = site.footer1;
            document.getElementById('footer-logo').src = site.logo_url;
            document.getElementById('footer-part2').innerText = site.footer2;


            // --- 6. NAVIGATION SETUP ---
            document.getElementById('nav-sep').innerText = site.navigation_separator;

            const prevLink = document.getElementById('nav-prev');
            prevLink.innerText = site.navigation_previous;
            if(storyTile.config.prev_story_url) {
                prevLink.href = storyTile.config.prev_story_url;
                prevLink.classList.remove('opacity-50', 'pointer-events-none');
            }

            const nextLink = document.getElementById('nav-next');
            nextLink.innerText = site.navigation_next;
            if(storyTile.config.next_story_url) {
                nextLink.href = storyTile.config.next_story_url;
                nextLink.classList.remove('opacity-50', 'pointer-events-none');
            }


            // --- 7. MEDIA RENDER (with Caption) ---
            const mediaBox = document.getElementById('media-container');
            const isMobile = window.innerWidth < 768; 

            if (storyTile.media.media_use_soft_bg) mediaBox.classList.add('soft-bg');
            
            let mediaHTML = '';
            const sizeValue = parseInt(storyTile.media.media_size) || 100;
            const sizeStyle = (sizeValue <= 100) ? `style="width: ${sizeValue}%; margin: 0 auto; display: block;"` : `style="width: 100%; margin: 0 auto; display: block;"`;


            // Check if it's a video based on the URL ending
            const isVideo = storyTile.media.media_url.match(/\.(mp4|webm|mov|ogg)$/i); 

            if (isVideo) {
                let videoSrc = storyTile.media.media_url; 
                let videoType = 'video/mp4';
                
                // Use mobile URL/webp if available and on mobile
                if (isMobile && storyTile.media.media_mobile_url && storyTile.media.media_mobile_url.match(/\.webp$/i)) {
                    videoSrc = storyTile.media.media_mobile_url;
                    videoType = 'image/webp'; // WebP is often used for animated media on mobile
                }
                
                mediaHTML = `
                    <video autoplay loop muted playsinline class="w-full h-auto" ${sizeStyle}>
                        <source src="${videoSrc}" type="${videoType}">
                    </video>
                `;
            } else {
                mediaHTML = `<img src="${storyTile.media.media_url}" alt="${storyTile.media.media_caption || storyTile.content.tile_story_title}" class="w-full h-auto object-contain" ${sizeStyle}>`;
            }
            mediaBox.innerHTML = mediaHTML;
            
            // Display Caption
            if (storyTile.media.media_caption) {
                document.getElementById('media-caption').innerText = storyTile.media.media_caption;
            }


            // --- 8. CONTENT RENDER (Manual Block Assembly for new JSON structure) ---
            document.getElementById('content-title').innerText = storyTile.content.tile_story_title;
            // Use description as the intro content for the story page
            document.getElementById('content-intro').innerHTML = storyTile.content.tile_story_description; 

            const dynamicContainer = document.getElementById('dynamic-content');
            dynamicContainer.innerHTML = ''; // Clear previous content

            // Block 1: Subtitle 1 + Text 1
            if (storyTile.content.story_subtitle1) {
                dynamicContainer.innerHTML += `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 border-l-4 nuance-border-l pl-4">${storyTile.content.story_subtitle1}</h2>`;
            }
            if (storyTile.content.story_text1) {
                dynamicContainer.innerHTML += `<div class="text-gray-600 dark:text-gray-300 leading-relaxed formatted-text">${storyTile.content.story_text1}</div>`;
            }

            // Block 2: Subtitle 2 + Text 2 (Handle optional keys)
            const subtitle2 = storyTile.content['story_subtitle2'] || storyTile.content['story_subtitle2(optional)'];
            const text2 = storyTile.content['story_text2'] || storyTile.content['story_text2)optional)'];
            
            if (subtitle2) {
                dynamicContainer.innerHTML += `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 border-l-4 nuance-border-l pl-4">${subtitle2}</h2>`;
            }
            if (text2) {
                dynamicContainer.innerHTML += `<div class="text-gray-600 dark:text-gray-300 leading-relaxed formatted-text">${text2}</div>`;
            }

            // Block 3: Attachment
            const block = storyTile.attachement;
            let blockHTML = '';

            switch(block.type.toLowerCase()) {
                case 'paypal_button':
                    blockHTML = `
                        <div class="py-4">
                            <a href="https://www.paypal.com/donate?hosted_button_id=${block.hosted_id}" target="_blank" class="paypal-btn shadow-lg hover:shadow-xl transform transition hover:-translate-y-1">
                                <i data-lucide="heart" class="w-5 h-5 text-red-600"></i>
                                <span>${block.text || "Support a Way Forward"}</span>
                            </a>
                        </div>`;
                    break;
                case 'link':
                    blockHTML = `
                        <a href="${block.url}" class="inline-flex items-center gap-2 nuance-text font-medium hover:underline mt-2">
                            <i data-lucide="${block.action === 'download' ? 'download' : 'link'}" class="w-4 h-4"></i>
                            ${block.text}
                        </a>`;
                    break;
            }
            dynamicContainer.innerHTML += blockHTML;

            lucide.createIcons();
        }

        loadPortfolio();
    </script>
</body>
</html>